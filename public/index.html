<!DOCTYPE html>
<html>
<head>
  <title>Expense Tracker Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      justify-content: center;
      padding: 40px 0;
    }

    .card {
      background: white;
      width: 500px;
      border-radius: 14px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }

    h2 {
      margin-top: 0;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .password-wrapper {
      position: relative;
    }

    .toggle-btn {
      position: absolute;
      right: 10px;
      top: 8px;
      cursor: pointer;
      font-size: 12px;
      color: #667eea;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      cursor: pointer;
      margin-bottom: 10px;
      font-weight: bold;
    }

    button.delete {
      background: #e74c3c;
      width: auto;
      padding: 4px 8px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      display: flex;
      justify-content: space-between;
      background: #f3f3f3;
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 6px;
    }

    .hidden {
      display: none;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="card">

  <h2>Expense Tracker Pro</h2>

  <!-- AUTH -->
  <div id="authSection">
    <h3>Register</h3>
    <input id="regEmail" placeholder="Email">

    <div class="password-wrapper">
      <input id="regPassword" type="password" placeholder="Password">
      <span class="toggle-btn" onclick="togglePassword('regPassword', this)">Show</span>
    </div>

    <button onclick="register()">Create Account</button>

    <h3>Login</h3>
    <input id="loginEmail" placeholder="Email">

    <div class="password-wrapper">
      <input id="loginPassword" type="password" placeholder="Password">
      <span class="toggle-btn" onclick="togglePassword('loginPassword', this)">Show</span>
    </div>

    <button onclick="login()">Login</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">

    <button onclick="logout()">Logout</button>

    <div class="row">
      <input id="title" placeholder="Title">
      <input id="amount" type="number" placeholder="Amount">
    </div>

    <select id="category">
      <option>General</option>
      <option>Food</option>
      <option>Travel</option>
      <option>Shopping</option>
      <option>Bills</option>
    </select>

    <button onclick="addExpense()">Add Expense</button>

    <h4>Filter</h4>
    <select id="filterCategory" onchange="loadExpenses()">
      <option value="">All</option>
      <option>General</option>
      <option>Food</option>
      <option>Travel</option>
      <option>Shopping</option>
      <option>Bills</option>
    </select>

    <h4>Total This Month: ₹<span id="monthlyTotal">0</span></h4>

    <ul id="expenses"></ul>

    <canvas id="categoryChart"></canvas>
    <canvas id="monthlyChart"></canvas>

  </div>

</div>

<script>
  const API = "https://expense-tracker-saas-production.up.railway.app/api";
  let token = localStorage.getItem("token");
  let categoryChart;
  let monthlyChart;

  const authSection = document.getElementById("authSection");
  const dashboard = document.getElementById("dashboard");

  if (token) showDashboard();

  function togglePassword(id, btn) {
    const input = document.getElementById(id);
    if (input.type === "password") {
      input.type = "text";
      btn.textContent = "Hide";
    } else {
      input.type = "password";
      btn.textContent = "Show";
    }
  }

  function showDashboard() {
    authSection.classList.add("hidden");
    dashboard.classList.remove("hidden");
    loadExpenses();
  }

  function logout() {
    localStorage.removeItem("token");
    token = null;
    dashboard.classList.add("hidden");
    authSection.classList.remove("hidden");
  }

  async function register() {
    const email = regEmail.value;
    const password = regPassword.value;

    const res = await fetch(API + "/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    alert(data.message);
  }

  async function login() {
    const email = loginEmail.value;
    const password = loginPassword.value;

    const res = await fetch(API + "/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (data.token) {
      localStorage.setItem("token", data.token);
      token = data.token;
      showDashboard();
    } else {
      alert("Login failed");
    }
  }

  async function addExpense() {
    const title = document.getElementById("title").value;
    const amount = document.getElementById("amount").value;
    const category = document.getElementById("category").value;

    if (!title || !amount) return alert("Enter title & amount");

    await fetch(API + "/expenses", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        title,
        amount: parseFloat(amount),
        category
      })
    });

    document.getElementById("title").value = "";
    document.getElementById("amount").value = "";

    loadExpenses();
  }

  async function deleteExpense(id) {
    await fetch(API + "/expenses/" + id, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });
    loadExpenses();
  }

  async function loadExpenses() {
    const filter = document.getElementById("filterCategory").value;
    let url = API + "/expenses";
    if (filter) url += "?category=" + filter;

    const res = await fetch(url, {
      headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();

    const list = document.getElementById("expenses");
    list.innerHTML = "";

    let monthlyTotal = 0;
    const categoryTotals = {};
    const monthlyTotals = {};

    const currentMonth = new Date().getMonth();

    data.forEach(exp => {
      const date = new Date(exp.created_at);
      const month = date.toLocaleString('default', { month: 'short' });

      if (date.getMonth() === currentMonth) {
        monthlyTotal += parseFloat(exp.amount);
      }

      categoryTotals[exp.category] =
        (categoryTotals[exp.category] || 0) + parseFloat(exp.amount);

      monthlyTotals[month] =
        (monthlyTotals[month] || 0) + parseFloat(exp.amount);

      const li = document.createElement("li");
      li.innerHTML = `
        <span>${exp.title} - ₹${exp.amount} (${exp.category})</span>
        <button class="delete" onclick="deleteExpense(${exp.id})">X</button>
      `;
      list.appendChild(li);
    });

    document.getElementById("monthlyTotal").textContent = monthlyTotal;

    renderCategoryChart(categoryTotals);
    renderMonthlyChart(monthlyTotals);
  }

  function renderCategoryChart(dataObj) {
    const ctx = document.getElementById("categoryChart");

    if (categoryChart) categoryChart.destroy();

    categoryChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: Object.keys(dataObj),
        datasets: [{
          data: Object.values(dataObj)
        }]
      }
    });
  }

  function renderMonthlyChart(dataObj) {
    const ctx = document.getElementById("monthlyChart");

    if (monthlyChart) monthlyChart.destroy();

    monthlyChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(dataObj),
        datasets: [{
          label: "Monthly Spending",
          data: Object.values(dataObj)
        }]
      }
    });
  }
</script>

</body>
</html>